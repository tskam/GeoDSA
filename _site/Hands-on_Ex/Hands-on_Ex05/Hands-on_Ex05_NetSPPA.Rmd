---
title: "Hands-on Exercise 5: Network Constrained Spatial Point Patterns Analysis (NetKDE)"
description: 
author:
  - name: Dr. Kam Tin Seong, Associate Professor of Information Systems (Practice) 
    url: https://www.smu.edu.sg/faculty/profile/9618/KAM-Tin-Seong
    affiliation: School of Computing and Information Systems, Singapore Management University
    affiliation_url: https://scis.smu.edu.sg/
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    code_folding: false
    toc: true
    toc_depth: 4
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=TRUE, message=FALSE, warning = FALSE)
```

# Overview

# The Data

## Installing and launching the R packages

In this hands-on exercise, five R packages will be used, they are:

-[rgdal](https://cran.r-project.org/web/packages/rgdal/index.html), which provides bindings to the ['Geospatial' Data Abstraction Library (GDAL) (>= 1.11.4)](https://gdal.org/) and access to projection/transformation operations from the [PROJ](https://proj.org/) library.  In this exercise, rgdal will be used to import geospatial data in R and store as [sp](https://cran.r-project.org/web/packages/sp/vignettes/intro_sp.pdf) objects. 

- [**spatstat**](https://spatstat.org/), which has a wide range of useful functions for point pattern analysis.  In this hands-on exercise, it will be used to perform 1st- and 2nd-order spatial point patterns analysis and derive kernel density estimation (KDE) layer.

- [**raster**](https://cran.r-project.org/web/packages/raster/) which reads, writes, manipulates, analyses and model of gridded spatial data (i.e. raster).  In this hands-on exercise, it will be used to convert image output generate by spatstat into raster format.

- [**maptools**](https://cran.r-project.org/web/packages/maptools/index.html) which provides a set of tools for manipulating geographic data.  In this hands-on exercise, we mainly use it to convert *Spatial* objects into *ppp* format of **spatstat**.

- [**tmap**](https://cran.r-project.org/web/packages/tmap/index.html) which provides functions for plotting cartographic quality static point patterns maps or interactive maps by using [leaflet](https://leafletjs.com/) API.

Use the code chunk below to install and launch the five R packages.

```{r}
packages = c('sp', 'rgeos', 'rgdal', 'maptools', 'spNetwork', 'raster', 'classInt', 'RColorBrewer', 'ggplot2', 'tmap')
for (p in packages){
if(!require(p, character.only = T)){
install.packages(p)
}
library(p,character.only = T)
}
```


# Data Import and Preparation

The data sets are in ESRI shapefile format.  The code chunk below uses readOGD() of rgdal package to important Punggol_St and Punggol_CC geospatial data sets into RStudio as SpatialLinesDataFrame and SpatialPointsDataFrame respectively.

```{r}
network <- readOGR(dsn="data/geospatial", 
                   layer="Punggol_St",
                   verbose = FALSE)
childcare <- readOGR(dsn="data/geospatial",
                     layer="Punggol_CC",
                     verbose = FALSE)
```


```{r}
childcare <-spTransform(childcare, CRS("+init=epsg:3414"))
network <- spTransform(network,CRS("+init=epsg:3414"))
```


Then plotting the data

```{r}
plot(network)
plot(childcare,add=T,col='red',pch = 19)
```

The code chunk below uses interactive mapping function of tmap package to create an interactive map.

```{r}
tmap_mode('view')
tm_shape(childcare)+
  tm_dots()
tmap_mode('plot')
```

Then calculating some lixels to use as sampling points

```{r}
lixels <- lixelize_lines(network,700,mindist = 350)
samples <- lines_center(lixels)
```

# Network Constrained KDE

Performing NetKDE

```{r}
densities <- nkde(network, 
                  events = childcare,
                  w = rep(1,nrow(childcare)),
                  samples = samples,
                  kernel_name = "quartic",
                  bw = 300, div= "bw", 
                  method = "discontinuous", digits = 1, tol = 1,
                  grid_shape = c(1,1), max_depth = 8,
                  agg = 5, #we aggregate events within a 5m radius (faster calculation)
                  sparse = TRUE,
                  verbose = FALSE)
```

```{r}
samples$density <- densities
lixels$density <- densities
```

```{r}
# rescaling to help the mapping
samples$density <- samples$density*1000000
lixels$density <- lixels$density*1000000
```


## Mapping NKDE

```{r}
tmap_mode('view')
tm_shape(lixels)+
  tm_lines(col="density")+
tm_shape(childcare)+
  tm_dots()
tmap_mode('plot')
```

# Network Constrained G- and K-Function Analysis

```{r}
kfun_childcare <- kfunctions(network, childcare,
                           start = 0, end = 1000, step = 50, 
                           width = 50, nsim = 50, resolution = 50,
                           verbose = FALSE, conf_int = 0.05)
kfun_childcare$plotk
```